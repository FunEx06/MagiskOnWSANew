name: Auto Build and Publish

on:
  schedule:
    # this means every other Saturday at 12:00 UTC
    - cron: '0 12 * * 6/2' # run every two week
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Install Git
      run: sudo apt-get install git

    - name: Clone repository
      run: git clone https://github.com/LSPosed/MagiskOnWSALocal.git

    - name: Install dependencies
      run: |
        cd MagiskOnWSALocal
        # insert the commands to install dependencies here
        # since dependencies are not specified, I will leave this comment here for you to replace with the appropriate commands

    - name: Install dependencies
      run: |
        cd MagiskOnWSALocal
        # Install qemu-img
        sudo apt-get update
        sudo apt-get install -y qemu-utils
        sudo apt-get install -y qemu-utils attr
        # insert the commands to install other dependencies here
        # since dependencies are not specified, I will leave this comment here for you to replace with the appropriate commands

    - name: Build
      run: |
        cd MagiskOnWSALocal
        chmod +x ./scripts/build.sh
        ./scripts/build.sh --arch x64 --release-type retail --root-sol magisk --gapps-brand MindTheGapps --remove-amazon --magisk-ver stable

    - name: Setup GitHub CLI
      run: |
        curl -sSL https://github.com/cli/cli/releases/download/v2.0.0/gh_2.0.0_linux_amd64.tar.gz -o gh.tar.gz
        tar xzf gh.tar.gz
        sudo install gh*/bin/gh /usr/local/bin

    - name: Authenticate with GitHub CLI
      run: echo "${{ secrets.PUBLISH_TOKEN }}" | gh auth login --with-token

    - name: Publish new release
      run: |
        cd MagiskOnWSALocal/output
        # Compress the output directory to zip
        DIR=$(ls -d */)
        zip -r "${DIR%/}.zip" "$DIR"
        FILE=$(ls *.zip)
        VERSION=$(date +%Y%m%d%H%M)
        # Extract the release name from the file name by splitting on underscores and taking the first two parts
        NAME=$(echo $FILE | cut -d '_' -f -2)
        # Define the release note
        NOTES=$(cat << EOF
        **由GitHub Action自动构建的最新版MagiskOnWSA**

        ## **安装指南**

        ### 安装:

        解压文件夹，拷贝全部文件到任意位置（推荐C盘下创建名为WSA的文件夹）  

        双击运行*run.bat*

        ### 更新:

        解压文件夹，关闭安卓子系统，复制文件到你原来安装的文件夹，覆盖文件，并再次运行*run.bat*

        ### 移动:

        移动后运行*run.bat*即可

        提示：最好目录中不含有特殊符号
        EOF
        )
        gh release create "$NAME-B$VERSION" $FILE -R yige-yigeren/MagiskOnWSAAuto -t "$NAME Build$(date +%Y%m%d)"  -n "$NOTES"
        
    - name: Delete old releases
      run: |
        for release in $(gh release list -R yige-yigeren/MagiskOnWSAAuto --json tagName -q '.[].tagName'); do
          gh release delete $release -y -R yige-yigeren/MagiskOnWSAAuto
        done
